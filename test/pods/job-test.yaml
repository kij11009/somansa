# Job 테스트용 YAML
# 사용법: kubectl apply -f test/job-test.yaml
# 삭제: kubectl delete -f test/job-test.yaml

---
# 1. 성공하는 Job - Hello World
apiVersion: batch/v1
kind: Job
metadata:
  name: hello-job
  namespace: default
  labels:
    app: test-job
    type: success
spec:
  # Job이 성공적으로 완료되어야 하는 횟수
  completions: 1
  # 동시에 실행할 Pod 수
  parallelism: 1
  # 재시도 제한
  backoffLimit: 4
  template:
    metadata:
      labels:
        app: test-job
        type: success
    spec:
      restartPolicy: Never
      containers:
      - name: hello
        image: busybox:1.36
        command:
        - /bin/sh
        - -c
        args:
        - |
          echo "==================================="
          echo "Hello from K8s Doctor Test Job!"
          echo "==================================="
          echo "Current time: $(date)"
          echo "Hostname: $(hostname)"
          echo "Simulating work..."
          sleep 10
          echo "Job completed successfully!"

---
# 2. 실패하는 Job - 테스트용
apiVersion: batch/v1
kind: Job
metadata:
  name: failing-job
  namespace: default
  labels:
    app: test-job
    type: failure
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 3  # 3번까지 재시도
  template:
    metadata:
      labels:
        app: test-job
        type: failure
    spec:
      restartPolicy: Never
      containers:
      - name: fail
        image: busybox:1.36
        command:
        - /bin/sh
        - -c
        args:
        - |
          echo "Attempt: $(cat /dev/urandom | tr -dc '0-9' | fold -w 1 | head -n 1)"
          sleep 5
          exit 1

---
# 3. 병렬 실행 Job - 5개 완료 필요
apiVersion: batch/v1
kind: Job
metadata:
  name: parallel-job
  namespace: default
  labels:
    app: test-job
    type: parallel
spec:
  # 5개의 성공적인 완료 필요
  completions: 5
  # 동시에 2개씩 실행
  parallelism: 2
  backoffLimit: 6
  template:
    metadata:
      labels:
        app: test-job
        type: parallel
    spec:
      restartPolicy: Never
      containers:
      - name: worker
        image: busybox:1.36
        command:
        - /bin/sh
        - -c
        args:
        - |
          echo "Worker started: $(hostname)"
          echo "Processing task..."
          sleep $((RANDOM % 20 + 10))
          echo "Task completed: $(hostname)"

---
# 4. Pi 계산 Job (공식 Kubernetes 예제)
apiVersion: batch/v1
kind: Job
metadata:
  name: pi-calculation
  namespace: default
  labels:
    app: test-job
    type: calculation
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 4
  template:
    metadata:
      labels:
        app: test-job
        type: calculation
    spec:
      restartPolicy: Never
      containers:
      - name: pi
        image: perl:5.34
        command:
        - perl
        args:
        - -Mbignum=bpi
        - -wle
        - print bpi(2000)
